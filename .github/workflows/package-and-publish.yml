name: Release Helm Chart

on:
  push:
    branches:
      - main
    paths:
      - 'chart/**/Chart.yaml'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Get changed charts
        id: changed_charts
        run: |
          CHARTS=$(ls -d chart/*/ | xargs -n1 basename)
          echo "charts<<EOF" >> $GITHUB_OUTPUT
          echo "$CHARTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Charts to process: $CHARTS"

      - name: Helm lint
        run: |
          for chart in chart/*/; do
            echo "Linting $chart"
            helm lint "$chart"
          done

      - name: Package charts
        run: |
          mkdir -p .charts
          for chart in chart/*/; do
            echo "Packaging $chart"
            helm package "$chart" -d .charts
          done

      - name: Create index and landing page
        run: |
          helm repo index .charts --url https://benni1390.github.io/fddb-exporter-deployment
          python3 - <<'PY'
          from pathlib import Path
          html_content = '''<!doctype html>
          <html>
          <head>
            <meta charset="utf-8">
            <meta http-equiv="refresh" content="0; url=https://github.com/benni1390/fddb-exporter-deployment">
            <title>Redirecting to fddb-exporter-deployment</title>
          </head>
          <body>
            <p>Redirecting to <a href="https://github.com/benni1390/fddb-exporter-deployment">GitHub Repository</a>...</p>
          </body>
          </html>'''
          Path('.charts/index.html').write_text(html_content)
          PY

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./.charts

